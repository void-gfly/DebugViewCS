<ui:FluentWindow
    x:Class="DebugViewCS.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:vm="clr-namespace:DebugViewCS.ViewModels"
    xmlns:conv="clr-namespace:DebugViewCS.Converters"
    Title="DebugView CS v1.0.1"
    Width="1200" Height="700"
    MinWidth="800" MinHeight="400"
    WindowStartupLocation="CenterScreen"
    ExtendsContentIntoTitleBar="True"
    Icon="Aq9.ico">

    <Window.DataContext>
        <vm:MainViewModel />
    </Window.DataContext>

    <Window.Resources>
        <conv:ProcessColorConverter x:Key="ProcessColorConverter" />
        <conv:ProcessForegroundConverter x:Key="ProcessForegroundConverter" />
        <conv:MessageColorConverter x:Key="MessageColorConverter" />

        <BooleanToVisibilityConverter x:Key="BoolToVis" />

        <!-- 时间格式化 -->
        <Style x:Key="MonoTextBlock" TargetType="TextBlock">
            <Setter Property="FontFamily" Value="Cascadia Code, Consolas, Courier New" />
            <Setter Property="FontSize" Value="12.5" />
            <Setter Property="VerticalAlignment" Value="Center" />
            <Setter Property="Padding" Value="4,2" />
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />  <!-- TitleBar -->
            <RowDefinition Height="Auto" />  <!-- Toolbar -->
            <RowDefinition Height="*" />     <!-- LogList -->
            <RowDefinition Height="Auto" />  <!-- StatusBar -->
        </Grid.RowDefinitions>

        <!-- Title Bar -->
        <ui:TitleBar Grid.Row="0" Title="DebugView CS v1.0.1" ShowMaximize="True" ShowMinimize="True">
            <ui:TitleBar.Icon>
                <ui:ImageIcon Source="Aq9.ico" />
            </ui:TitleBar.Icon>
        </ui:TitleBar>

        <!-- Toolbar -->
        <Border Grid.Row="1" Padding="8,6" BorderThickness="0,0,0,1"
                BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- 捕获按钮 -->
                <ui:Button Grid.Column="0" Margin="0,0,4,0"
                           Command="{Binding ToggleCaptureCommand}"
                           Icon="{ui:SymbolIcon Play24}"
                           ToolTip="开始/停止捕获">
                    <ui:Button.Style>
                        <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsCapturing}" Value="True">
                                    <Setter Property="Icon" Value="{ui:SymbolIcon Pause24}" />
                                    <Setter Property="Content" Value="暂停" />
                                </DataTrigger>
                                <DataTrigger Binding="{Binding IsCapturing}" Value="False">
                                    <Setter Property="Icon" Value="{ui:SymbolIcon Play24}" />
                                    <Setter Property="Content" Value="捕获" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ui:Button.Style>
                </ui:Button>

                <!-- 清除及自动清除设置 -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="0,0,4,0">
                    <ui:Button Content="清除"
                               Command="{Binding ClearCommand}"
                               Icon="{ui:SymbolIcon Delete24}"
                               ToolTip="清除所有日志"
                               Margin="0,0,1,0" />
                    <ui:Button Padding="4,5"
                               ToolTip="清除选项"
                               Click="ClearOptions_Click">
                        <ui:SymbolIcon Symbol="ChevronDown20" FontSize="14" />
                        <ui:Button.ContextMenu>
                            <ContextMenu Placement="Bottom">
                                <MenuItem Header="5000条后自动清空" IsCheckable="True" IsChecked="{Binding IsAutoClear5000, Mode=OneWay}" Command="{Binding SetClearModeCommand}" CommandParameter="AutoClear_5000"/>
                                <MenuItem Header="10000条后自动清空" IsCheckable="True" IsChecked="{Binding IsAutoClear10000, Mode=OneWay}" Command="{Binding SetClearModeCommand}" CommandParameter="AutoClear_10000"/>
                                <MenuItem Header="保持最大5000条" IsCheckable="True" IsChecked="{Binding IsKeepMax5000, Mode=OneWay}" Command="{Binding SetClearModeCommand}" CommandParameter="KeepMax_5000"/>
                                <MenuItem Header="保持最大10000条" IsCheckable="True" IsChecked="{Binding IsKeepMax10000, Mode=OneWay}" Command="{Binding SetClearModeCommand}" CommandParameter="KeepMax_10000"/>
                            </ContextMenu>
                        </ui:Button.ContextMenu>
                    </ui:Button>
                </StackPanel>

                <!-- 自动滚动 -->
                <CheckBox Grid.Column="2" Margin="8,0,4,0"
                          Content="自动滚动"
                          IsChecked="{Binding AutoScroll}"
                          VerticalAlignment="Center" />

                <!-- 分隔 -->
                <Separator Grid.Column="3" Margin="8,4" />

                <!-- 过滤与设置 -->
                <StackPanel Grid.Column="4" Orientation="Horizontal" Margin="4,0" VerticalAlignment="Center">
                    <CheckBox Content="启用过滤" 
                              IsChecked="{Binding Settings.IsFilterEnabled}" 
                              Margin="0,0,8,0"
                              ToolTip="开启或关闭过滤模式"
                              VerticalAlignment="Center" />
                    <ui:Button Content="高级设置"
                               Icon="{ui:SymbolIcon Filter24}"
                               Click="OpenFilterSettings_Click"
                               VerticalAlignment="Center" />
                </StackPanel>

                <!-- 消息计数 -->
                <TextBlock Grid.Column="5" Margin="8,0"
                           VerticalAlignment="Center"
                           Foreground="{DynamicResource TextFillColorSecondaryBrush}">
                    <Run Text="{Binding VisibleMessages, StringFormat='{}{0:N0}'}" />
                    <Run Text=" / " />
                    <Run Text="{Binding TotalMessages, StringFormat='{}{0:N0}'}" />
                </TextBlock>
            </Grid>
        </Border>

        <!-- Log ListView -->
        <ListView Grid.Row="2" x:Name="LogListView"
                  ItemsSource="{Binding LogEntries}"
                  VirtualizingPanel.IsVirtualizing="True"
                  VirtualizingPanel.VirtualizationMode="Recycling"
                  VirtualizingPanel.IsContainerVirtualizable="True"
                  ScrollViewer.CanContentScroll="True"
                  ScrollViewer.IsDeferredScrollingEnabled="False"
                  SelectionMode="Extended"
                  BorderThickness="0"
                  Background="Transparent">
            <ListView.View>
                <GridView>
                    <GridViewColumn Header="#" Width="60">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Id}" Style="{StaticResource MonoTextBlock}"
                                           Foreground="{DynamicResource TextFillColorTertiaryBrush}" />
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>

                    <GridViewColumn Header="时间" Width="100">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Timestamp, StringFormat='HH:mm:ss.fff'}"
                                           Style="{StaticResource MonoTextBlock}"
                                           Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>

                    <GridViewColumn Header="PID" Width="60">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding ProcessId}" Style="{StaticResource MonoTextBlock}"
                                           Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>

                    <GridViewColumn Header="进程" Width="120">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding ProcessName}" Style="{StaticResource MonoTextBlock}"
                                           Foreground="{Binding ProcessName, Converter={StaticResource ProcessForegroundConverter}}" />
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>

                    <GridViewColumn Header="消息" Width="800">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Message}" Style="{StaticResource MonoTextBlock}"
                                           Foreground="{Binding Message, Converter={StaticResource MessageColorConverter}}"
                                           TextTrimming="CharacterEllipsis"
                                           ToolTip="{Binding Message}" />
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                </GridView>
            </ListView.View>

            <ListView.ItemContainerStyle>
                <Style TargetType="ListViewItem">
                    <Setter Property="Tag" Value="{Binding DataContext, RelativeSource={RelativeSource AncestorType=ListView}}" />
                    <Setter Property="ContextMenu">
                        <Setter.Value>
                            <ContextMenu>
                                <MenuItem Header="复制消息(完整)" 
                                          Command="{Binding PlacementTarget.Tag.CopyFullMessageCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                          CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                                <MenuItem Header="复制消息文本" 
                                          Command="{Binding PlacementTarget.Tag.CopyMessageTextCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                          CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                                <Separator />
                                <MenuItem Header="将进程名加入过滤" 
                                          Command="{Binding PlacementTarget.Tag.AddProcessToFilterCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                          CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                            </ContextMenu>
                        </Setter.Value>
                    </Setter>
                    <Setter Property="Background" Value="{Binding ProcessName, Converter={StaticResource ProcessColorConverter}}" />
                    <Setter Property="Foreground" Value="{Binding Message, Converter={StaticResource MessageColorConverter}}" />
                    <Setter Property="BorderThickness" Value="0" />
                    <Setter Property="Padding" Value="0" />
                    <Setter Property="Margin" Value="0" />
                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                    <!-- 重写 Template 以抛弃系统默认 Aero 主题高亮 -->
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ListViewItem">
                                <Border Background="{TemplateBinding Background}" 
                                        BorderBrush="{TemplateBinding BorderBrush}" 
                                        BorderThickness="{TemplateBinding BorderThickness}"
                                        TextElement.Foreground="{TemplateBinding Foreground}">
                                    <Grid>
                                        <!-- 用于 Hover 和 Select 状态的遮罩层 -->
                                        <Border x:Name="HoverBorder" Background="Transparent" />
                                        <Border x:Name="SelectedBorder" Background="Transparent" />
                                        <!-- 这是实际渲染列的占位层 -->
                                        <GridViewRowPresenter Content="{TemplateBinding Content}" Columns="{TemplateBinding GridView.ColumnCollection}" />
                                    </Grid>
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <!-- 设置一个纯白半透明的 Hover 色，能在任何底色上清晰反馈 -->
                                        <Setter TargetName="HoverBorder" Property="Background" Value="#25FFFFFF" />
                                    </Trigger>
                                    <Trigger Property="IsSelected" Value="True">
                                        <!-- 选中颜色加深 -->
                                        <Setter TargetName="SelectedBorder" Property="Background" Value="#40FFFFFF" />
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </ListView.ItemContainerStyle>
        </ListView>

        <!-- Status Bar -->
        <Border Grid.Row="3" Padding="12,0" Height="30"
                Background="{DynamicResource ControlFillColorDefaultBrush}"
                BorderThickness="0,1,0,0"
                BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0"
                           Text="{Binding StatusText}"
                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                           VerticalAlignment="Center"
                           Margin="0,0,16,0" />

                <!-- 用于显示最新未过滤消息，超出部分截断 -->
                <TextBlock Grid.Column="1"
                           Text="{Binding LastUnfilteredMessage}"
                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                           VerticalAlignment="Center"
                           TextTrimming="CharacterEllipsis"
                           TextWrapping="NoWrap"
                           ToolTip="{Binding LastUnfilteredMessage}" />
            </Grid>
        </Border>
    </Grid>
</ui:FluentWindow>
